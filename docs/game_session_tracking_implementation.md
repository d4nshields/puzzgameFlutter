# Game Session Tracking Implementation

## Overview

This document describes the implementation of comprehensive game session tracking in Puzzle Nook, enabling detailed analytics and user behavior insights while supporting both authenticated and anonymous users.

## Architecture

### Core Components

1. **GameSessionTrackingService Interface** (`/lib/core/domain/services/game_session_tracking_service.dart`)
   - Defines the contract for tracking game sessions and user statistics
   - Supports both authenticated users and anonymous usage tracking
   - Provides methods for session lifecycle management

2. **SupabaseGameSessionTrackingService** (`/lib/core/infrastructure/supabase/supabase_game_session_tracking_service.dart`)
   - Implements the tracking interface using Supabase backend
   - Handles device identification for anonymous tracking
   - Manages database interactions for all tracking operations

### Database Schema

#### Tables

1. **game_sessions**
   - `id` (UUID): Session identifier generated by game module
   - `user_id` (UUID): Link to authenticated user (nullable for anonymous)
   - `game` (TEXT): Game type identifier ('puzzle_nook')
   - `session_data` (JSONB): Detailed session information and progress
   - `started_at`/`ended_at` (TIMESTAMPTZ): Session timeline
   - `difficulty`, `puzzle_id`, `grid_size` (Additional columns for easier querying)

2. **game_stats**
   - `user_id` (UUID): User identifier
   - `game` (TEXT): Game type
   - `total_playtime` (INTEGER): Total seconds played
   - `completed_puzzles` (INTEGER): Number of completed puzzles
   - `last_played` (TIMESTAMPTZ): Most recent play session

3. **app_usage** (New)
   - `id` (UUID): Usage record identifier
   - `user_id` (UUID): User identifier (nullable for anonymous)
   - `device_id` (TEXT): Device identifier for anonymous tracking
   - `action` (TEXT): Action type ('app_launch', 'game_started', etc.)
   - `timestamp` (TIMESTAMPTZ): When the action occurred
   - `app_version`, `platform`: Technical metadata
   - `device_metadata` (JSONB): Device information
   - `usage_data` (JSONB): Action-specific data

4. **game_analytics** (View)
   - Aggregated view combining session data with computed metrics
   - Provides easy access to completion rates, duration, scores

### Integration Points

#### Game Lifecycle Tracking

1. **Game Start** (`StartGameUseCase`)
   - Records new session in `game_sessions` table
   - Captures initial game configuration (difficulty, puzzle type)
   - Links to authenticated user if available

2. **Game Progress** (`PuzzleGameSession`)
   - Updates session data on piece placement (correct/incorrect)
   - Tracks pause/resume events
   - Records game state changes

3. **Game Completion** (`PuzzleGameSession._onPuzzleCompleted`)
   - Records completion event with timing and score
   - Updates user statistics in `game_stats`

4. **Game End** (`EndGameUseCase`)
   - Finalizes session with complete results
   - Updates aggregated user statistics
   - Records final score, playtime, completion status

#### App Usage Tracking

1. **App Launch** (`main.dart`)
   - Records app startup events
   - Captures device and platform information
   - Works for both authenticated and anonymous users

2. **User Actions**
   - Sign-in/sign-out events
   - Game selection and configuration changes
   - Feature usage patterns

### Data Captured

#### Session-Level Data
```json
{
  "session_id": "uuid",
  "started_at": "2025-07-22T10:00:00Z",
  "puzzle_id": "sample_puzzle_01",
  "grid_size": 12,
  "difficulty": 2,
  "initial_score": 0,
  "current_score": 150,
  "pieces_placed": 25,
  "total_pieces": 144,
  "completion_percentage": 17,
  "last_piece_placed": {
    "piece_id": "3_4",
    "position": {"x": 120.5, "y": 180.3},
    "correct": true,
    "points_earned": 15,
    "timestamp": "2025-07-22T10:05:30Z"
  },
  "last_event": {
    "type": "pause",
    "timestamp": "2025-07-22T10:08:00Z",
    "data": {
      "pieces_placed": 25,
      "current_score": 150,
      "play_time_minutes": 8
    }
  }
}
```

#### User Statistics
- Total playtime across all sessions
- Number of completed puzzles
- High scores and completion rates
- Last played timestamp

#### Anonymous Usage Data
- App launches and session frequency
- Device types and platform distribution
- Feature usage without personal identification

## Implementation Benefits

### For Development
1. **Performance Monitoring**: Track game load times, completion rates
2. **Feature Usage**: Understand which puzzles and difficulty levels are popular
3. **User Engagement**: Measure session duration and retention
4. **Bug Detection**: Identify patterns in incomplete sessions

### For Users
1. **Progress Tracking**: Personal statistics and achievements
2. **Cross-Device Sync**: Resume progress on different devices (authenticated users)
3. **Personalization**: Difficulty recommendations based on performance

### Privacy-Conscious Design
1. **Anonymous Support**: Full functionality without user accounts
2. **Minimal Data**: Only game-relevant information is collected
3. **User Control**: Easy to disable tracking via settings
4. **GDPR Compliance**: Clear data retention and deletion policies

## Usage Examples

### Starting a Game Session
```dart
// In StartGameUseCase
final gameSession = await _gameModule.startGame(difficulty: difficulty);

// Automatically tracked:
await trackingService.startGameSession(
  gameSession: gameSession,
  user: currentUser, // null for anonymous
  gameType: 'puzzle_nook',
  initialSessionData: {
    'difficulty': difficulty,
    'started_via': 'game_screen',
  },
);
```

### Tracking Piece Placement
```dart
// In PuzzleGameSession.tryPlacePieceAtPosition
if (correct) {
  _trackPiecePlacement(piece, dropPosition, true, points);
} else {
  _trackPiecePlacement(piece, dropPosition, false, 0);
}
```

### Querying User Statistics
```dart
final stats = await trackingService.getUserGameStats(
  userId: user.id,
  gameType: 'puzzle_nook',
);

print('Total playtime: ${stats['total_playtime']} seconds');
print('Completed puzzles: ${stats['completed_puzzles']}');
```

## Error Handling

All tracking operations are designed to fail gracefully:
- Game continues normally if tracking fails
- Errors are logged but don't interrupt gameplay
- Offline mode supported (tracking resumes when connection restored)

## Future Enhancements

1. **Achievement System**: Track specific accomplishments
2. **Leaderboards**: Compare performance with other users
3. **Analytics Dashboard**: Web interface for viewing aggregate statistics
4. **A/B Testing**: Track feature variants and user preferences
5. **Predictive Analytics**: Suggest puzzles based on user behavior

## Configuration

Tracking can be configured via environment variables or settings:
- Enable/disable anonymous tracking
- Adjust data retention periods
- Configure which events to track
- Set privacy levels for different user types

## Dependencies

- `supabase_flutter`: Database operations
- `device_info_plus`: Device identification
- `package_info_plus`: App version tracking
- `get_it`: Dependency injection

## Testing

The tracking system includes:
- Unit tests for service methods
- Integration tests for database operations
- Mock implementations for offline testing
- Performance tests for high-volume scenarios

This implementation provides a solid foundation for understanding user engagement while respecting privacy and maintaining game performance.
